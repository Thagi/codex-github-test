name: Codex Issue Fix

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process"
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: codex-issue-fix-${{ github.event.issue.number || inputs.issue_number || github.run_id }}
  cancel-in-progress: false

jobs:
  fix:
    if: >-
      (github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      github.event.label.name == 'codex:fix') ||
      (github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      !github.event.issue.pull_request &&
      contains(github.event.comment.body, '/codex fix')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Check OPENAI_API_KEY
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "Repository secret OPENAI_API_KEY is required."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Resolve issue context
        id: issue
        uses: actions/github-script@v8
        env:
          DISPATCH_ISSUE_NUMBER: ${{ inputs.issue_number }}
        with:
          script: |
            let issueNumber = context.payload.issue?.number;
            if (!issueNumber && process.env.DISPATCH_ISSUE_NUMBER) {
              issueNumber = Number(process.env.DISPATCH_ISSUE_NUMBER);
            }
            if (!issueNumber || Number.isNaN(issueNumber)) {
              core.setFailed("Could not resolve issue number.");
              return;
            }

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            core.setOutput("number", String(issue.number));
            core.setOutput("title", issue.title || "");
            core.setOutput("body", (issue.body || "").slice(0, 12000));
            core.setOutput("url", issue.html_url || "");
            core.setOutput("author", issue.user?.login || "");

      - name: Build runtime prompt
        id: prompt
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_URL: ${{ steps.issue.outputs.url }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
          ISSUE_AUTHOR: ${{ steps.issue.outputs.author }}
        run: |
          PROMPT_FILE="$RUNNER_TEMP/fix-issue.runtime.md"
          cp .github/codex/prompts/fix-issue.md "$PROMPT_FILE"
          {
            echo
            echo "## Issue Context"
            echo "- Number: #${ISSUE_NUMBER}"
            echo "- URL: ${ISSUE_URL}"
            echo "- Reporter: @${ISSUE_AUTHOR}"
            echo "- Title: ${ISSUE_TITLE}"
            echo
            echo "### Body"
            echo "${ISSUE_BODY}"
          } >> "$PROMPT_FILE"
          echo "path=$PROMPT_FILE" >> "$GITHUB_OUTPUT"

      - name: Run Codex
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: ${{ steps.prompt.outputs.path }}
          output-file: codex-output.md
          codex-args: '["--full-auto"]'
          sandbox: workspace-write
          safety-strategy: drop-sudo

      - name: Upload Codex report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-output-${{ github.run_id }}
          path: codex-output.md
          if-no-files-found: ignore

      - name: Create pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: codex/issue-${{ steps.issue.outputs.number }}-${{ github.run_id }}
          base: ${{ github.event.repository.default_branch }}
          title: "fix: issue #${{ steps.issue.outputs.number }} - ${{ steps.issue.outputs.title }}"
          body: |
            Automated fix generated by Codex for issue #${{ steps.issue.outputs.number }}.

            Closes #${{ steps.issue.outputs.number }}.
          commit-message: "fix: issue #${{ steps.issue.outputs.number }}"
          delete-branch: true

      - name: Comment back to issue
        if: always()
        uses: actions/github-script@v8
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
          CODEX_MESSAGE: ${{ steps.codex.outputs.final-message }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const prUrl = process.env.PR_URL || "";
            const prNumber = process.env.PR_NUMBER || "";
            const runUrl = process.env.RUN_URL;
            const summary = (process.env.CODEX_MESSAGE || "No summary returned by Codex.").slice(0, 3000);

            const lines = [];
            lines.push("Codex run finished.");
            lines.push("");
            lines.push(`- Run: ${runUrl}`);
            if (prUrl) {
              lines.push(`- PR: ${prUrl}`);
              if (prNumber) lines.push(`- PR Number: #${prNumber}`);
            } else {
              lines.push("- PR: not created (no committable diff or run failure)");
            }
            lines.push("");
            lines.push("Summary:");
            lines.push("```text");
            lines.push(summary);
            lines.push("```");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: lines.join("\n"),
            });
